# راهنمای استفاده از وب‌سرویس اسکای‌روم (نسخه آزمایشی)

##  آشنایی با وب‌سرویس اسکای‌روم

###  معرفی
وب‌سرویس اسکای‌روم با هدف یک‍پارچه‌سازی و بکارگیری سرویس‌های اسکای‌روم در سایر سامانه‌ها و برنامه‌های نرم‌افزاری طراحی و پیاده‌سازی شده است. با بهره‌گیری از وب‌سرویس اسکای‌روم می توانید سرویس‌ها، اتاق‌های مجازی، کاربران و سایر امکانات فراهم شده را از درون سامانه یا اپلیکیشن خود و با فراخوانی دستورات وب‌سرویس (API) مدیریت نمایید. همچنین در صورت نیاز می توانید با استفاده از سرویس احراز هویت یکپارچه (SSO)، بدون نیاز به ایجاد کاربر و درخواست کدکاربری و گذرواژه به هنگام ورود به اتاق مجازی، کاربران خود را از طریق ‌وبسایت و پایگاه داده خود احراز هویت کنید.

### مشخصات فنی
وب‌سرویس اسکای‌روم بر پایه REST طراحی و پیاده‌سازی گردیده است که در آن تلاش شده است تا ضمن الگوبرداری از استانداردهای رایج دنیا، سادگی در اولویت نخست باشد. از اینرو در وب‌سرویس اسکای‌روم تمامی درخواست(request)ها به شکل POST ارسال می گردند و تمامی پاسخ(response)ها نیز به فرمت JSON بازگردانده می شوند. همچنین به منظور تفکیک خطاهای شبکه و سرور از خطاهای برنامه، تمامی پاسخ‌ها از سوی وب‌سرویس، چه موفق چه ناموفق، با کد وضعیت 200 برگردانده می شود(200 = HTTP Status Code).

### آدرس وب‌سرویس
ساختار آدرس(URL) وب‌سرویس بدین‌گونه است:
```
https://www.your-website.ir/skyroom/api/{YOUR_API_KEY}
```  
که در آن `YOUR_API_KEY` یک رشته به طول ۲۸ حرف و کلید اختصاصی شما برای استفاده از وب‌سرویس می‌باشد. به این ترتیب این کلید همواره جزء ثابتی از آدرس وب‌سرویس برای تمامی درخواست‌های ارسالی خواهد بود.

### ارسال درخواست
شکل کلی یک درخواست به صورت زیر است که در آن `action` تابعی است که قصد فراخوانی آن را داریم و وجود آن همواره ضروری خواهد بود. سایر پارامترهای تابع، در صورت نیاز و به هر تعداد، در ادامه اضافه می شود:
```http
POST https://www.your-website.ir/skyroom/api/kcjsdhfisdofewr98eh498urwekj
{
  "action": "action-name",
  "param1": "param1-value",
  "param2": "param2-value",
  "param3": "param3-value",
  ...
}
```

### دریافت پاسخ
پاسخ‌ دریافتی از وب‌سرویس بسته به نوع درخواست می‌تواند یکی از انواع عدد`number`، رشته`string`، آرایه`[]` یا آبجکت`{}` باشد. در ادامه چند نمونه از اشکال مختلف پاسخ آمده است:
```json
12
```
```json
"https://www.skyroom.ir/ch/web-conference"
```
```json
[
  "item1",
  "item2",
  "item3"
]
```
```json
{
  "key1": "value1",
  "key2": "value2",
  "key3": [
    "item1",
    "item2",
    "item3"
  ]
}
```

### مدیریت خطاها
همانطور که پیشتر اشاره شد، تمامی پاسخ‌های دریافتی از سمت وب‌سرویس اعم از موفق یا ناموفق با کد وضعیت 200 ارسال می‌گردد. در نتیجه چنانچه مقدار این کد عددی غیر از 200 باشد نشان دهنده بروز خطای شبکه یا سرور می‌باشد. اما در مورد خطاهای  برنامه‌ای، پاسخ به شکل زیر خواهد بود:
```http
HTTP/1.1 200 OK
{
  "error": {
    "code": 10,
    "message": "The provided API key is invalid.",
    "data": "Additional data of any type"
  }
}
```
از این رو می‌بایست برای تشخیص بروز خطا وجود کلیدواژه `error` را بررسی کنید.

کد خطاهای عمومی به قرار زیر است:

|کد خطا|توضیح|
|:---:|---:|
|10|کلید API نامعتبر است.|
|11|درخواست شما معتبر نیست.|
|12|درخواست شما غیرمجاز است.|
|13|درخواست شما با خطا روبرو شد.|


## امکانات مدیریتی
امکانات مدیریتی ارایه شده در وب‌سرویس اسکای‌روم شامل سه بخش مدیریت سرویس‌ها، مدیریت اتاق‌ها و مدیریت کاربران می شود.

### ۱. مدیریت سرویس‌ها
(در دست پیاده سازی..)

<!---
هدف از سرویس‌ها در اسکای‌روم دسته‌بندی کردن اتاق‌های مجازی و همچنین اعمال برخی محدودیت‌ها همچون تعداد کاربر همزمان، حجم نفرساعت مصرفی، فضای دیسک، میزان آپلود و یا تعیین بازه زمانی برای بهره‌برداری از سرویس می‌باشد. برای ساخت اتاق‌های مجازی، وجود حداقل یک سرویس الزامی است.

#### مشخصات سرویس

|ویژگی|نوع|مقدار|
|:---|:---|---:|
|id|number|شناسه سرویس|
|title|string|عنوان سرویس به طول حداکثر ۱۲۸ حرف|
|description|string|شرح سرویس به طول حداکثر ۵۱۲ حرف|
|type|number|نوع سرویس (0: عمومی - 1: وب‌کنفرانس - 2: آموزش 3: وبینار 4: پخش زنده)|
|status|number|وضعیت سرویس (0: غیرفعال - 1: فعال)|
|max_online_users|number|سقف تعداد کاربر آنلاین|
|max_upload_size|number|اندازه مجاز برای آپلود فایل|
|disk_quota|number|فضای دیسک|
|time_limit|number|محدودیت نفرساعت|
|time_usage|number|نفرساعت مصرف شده|
|time_total|number|مجموع نفرساعت مصرف شده|
|start_time|Unix time|زمان شروع سرویس|
|stop_time|Unix time|زمان پایان سرویس|
|create_time|Unix time|زمان ایجاد سرویس|
|update_time|Unix time|آخرین بروزرسانی سرویس|

#### توابع سرویس
|نام تابع|شرح|مقدار بازگشتی|نوع مقدار بازگشتی
|:---|---:|---:|
|`getServices`|دریافت لیست سرویس‌های موجود|لیست سرویس‌ها|[]
|`getService`|دریافت مشخصات یک سرویس‌|مشخصات سرویس|{}
|`createService`|ایجاد سرویس‌ جدید|شناسه سرویس ایجاد شده|number
|`updateService`|بروزرسانی سرویس‌|true یا false|bool
|`deleteService`|حذف سرویس‌|true یا false|bool

#### دریافت لیست سرویس‌های موجود
##### درخواست:
```json
{
  "action": "getServices"
}
```

##### پاسخ:
```json
[
  {
    "id": 1,
    "title": "سرویس وب کنفرانس",
    "status": 1
  },
  {
    "id": 2,
    "title": "سرویس آموزش آنلاین",
    "status": 0
  }
]
```

#### دریافت مشخصات یک سرویس‌
##### درخواست:
```json
{
  "action": "getService",
  "service_id": 1
}
```

##### پاسخ:
```json
{
  "id": 1,
  "title": "سرویس وب کنفرانس",
  "description": null,
  "type": 1,
  "status": 1,
  "start_time": null,
  "stop_time": null,
  "create_time": 1479021195,
  "update_time": 1501559112,
  "max_online_users": 8,
  "time_limit": 720000,
  "time_usage": 184059,
  "time_total": 2487566,
  "max_upload_size": 20971520,
  "disk_quota": 1048576000
}
```

#### ایجاد سرویس‌ جدید
##### درخواست:
```json
{
  "action": "createService",
  "title": "سرویس آزمایشی"
}
```

##### پاسخ:
```json
3
```

#### بروزرسانی سرویس‌
##### درخواست:
```json
{
  "action": "updateService",
  "id": 3,
  "max_online_users": 50
}
```

##### پاسخ:
```json
true
```

#### حذف سرویس‌
##### درخواست:
```json
{
  "action": "deleteService",
  "id": 3
}
```

##### پاسخ:
```json
true
```
--->

### ۲. مدیریت اتاق‌ها
با استفاده از اتاق‌های مجازی می‌توان رویدادهای مختلف را به صورت همزمان و کاملا مجزا از یکدیگر برگزار نمود. هر اتاق دارای یک نام واحد می‌باشد که آدرس(URL) اتاق نیز با همین نام ساخته می‌شود و در نتیجه بهتر است این نام به صورت لاتین وارد شود. می توان برای اتاق‌ها برخی محدودیت‌ها همچون سقف کاربر آنلاین، میزان نفرساعت مصرفی و جلوگیری از ورود کاربران پیش از ورود اپراتور را بکار برد.

#### مشخصات اتاق

|ویژگی|نوع|مقدار|
|:---|:---|---:|
|id|number|شناسه اتاق|
|name|string|نام اتاق به لاتین و به طول حداکثر ۱۲۸ حرف|
|title|string|عنوان اتاق به طول حداکثر ۱۲۸ حرف|
|description|string|شرح اتاق به طول حداکثر ۵۱۲ حرف|
|status|number|وضعیت اتاق (0: غیرفعال - 1: فعال)|
|guest_login|bool|ورود به صورت میهمان|
|op_login_first|bool|ابتدا اپراتور وارد شود|
|max_users|number|سقف تعداد کاربر آنلاین|
|session_duration|number|طول جلسه|
|time_limit|number|محدودیت نفرساعت|
|time_usage|number|نفرساعت مصرف شده|
|time_total|number|مجموع نفرساعت مصرف شده|
|create_time|Unix time|زمان ایجاد اتاق|
|update_time|Unix time|آخرین بروزرسانی اتاق|

#### توابع اتاق
|نام تابع|شرح|مقدار بازگشتی|نوع مقدار بازگشتی
|:---|---:|---:|
|`getRooms`|دریافت لیست اتاق‌های موجود|لیست اتاق‌ها|[]
|`getRoom`|دریافت مشخصات یک اتاق|مشخصات اتاق|{}
|`getRoomURL`|دریافت آدرس یک اتاق|آدرس اتاق|string
|`createRoom`|ایجاد اتاق جدید|شناسه اتاق ایجاد شده|number
|`updateRoom`|بروزرسانی اتاق|true یا false|bool
|`deleteRoom`|حذف اتاق|true یا false|bool

#### دریافت لیست اتاق‌های موجود
##### درخواست:
```json
{
  "action": "getRooms"
}
```

##### پاسخ:
```json
[
  {
    "id": 1,
    "name": "meeting",
    "title": "اتاق جلسات",
    "status": 1
  },
  {
    "id": 2,
    "name": "learning-php",
    "title": "کلاس آموزش PHP",
    "status": 0
  }
]
```

#### دریافت مشخصات یک اتاق
##### درخواست:
```json
{
  "action": "getRoom",
  "room_id": 1
}
```

##### پاسخ:
```json
{
  "id": 1,
  "name": "meeting",
  "title": "اتاق جلسات",
  "description": null,
  "status": 1,
  "guest_login": false,
  "op_login_first": true,
  "max_users": 8,
  "session_duration": null,
  "time_limit": null,
  "time_usage": 184486,
  "time_total": 3144460,
  "create_time": 1479021434,
  "update_time": 1501559112
}
```

#### دریافت آدرس یک اتاق
##### درخواست:
```json
{
  "action": "getRoomURL",
  "room_id": 1
}
```

##### پاسخ:
```json
"https://www.skyroom.ir/ch/faramooz/meeting"
```

#### ایجاد اتاق جدید
##### درخواست:
```json
{
  "action": "createRoom",
  "name": "math-exercise",
  "title": "کلاس حل تمرین ریاضی",
  "guest_login": false,
  "op_login_first": true,
  "max_users": 10
}
```

##### پاسخ:
```json
3
```

#### بروزرسانی اتاق
##### درخواست:
```json
{
  "action": "updateRoom",
  "id": 3,
  "max_users": 20
}
```

##### پاسخ:
```json
true
```

#### حذف اتاق
##### درخواست:
```json
{
  "action": "deleteRoom",
  "id": 3
}
```

##### پاسخ:
```json
true
```

### ۳. مدیریت کاربران
برای ورود به اتاق‌های مجازی و شرکت در رویدادها نیاز به ساخت حساب کاربری خواهد بود. استفاده از سرویس SSO از این قاعده مستثنی هست. برای ساخت یک حساب کاربری، وارد کردن نام کاربری، گذرواژه و نام نمایشی الزامی است. با هر حساب کاربری تنها یک بار می‌توان وارد اتاق شد. اگر بخواهیم چند نفر به صورت همزمان از یک حساب کاربری استفاده کنند در این صورت می‌بایست یک حساب کاربری از نوع عمومی ایجاد کنید. پس از ساخت حساب کاربری نیاز است تا دسترسی کاربر به اتاق یا اتاق‌های مربوطه ایجاد شود.

#### مشخصات کاربر

|ویژگی|نوع|مقدار|
|:---|:---|---:|
|id|number|شناسه کاربر|
|username|string|نام کاربری به لاتین و به طول حداکثر ۳۲ حرف|
|password|string|گذرواژه به طول حداکثر ۱۲۸ حرف|
|email|string|آدرس ایمیل به طول حداکثر ۱۲۸ حرف|
|nickname|string|نام نمایشی به طول حداکثر ۱۲۸ حرف|
|fname|string|نام به طول حداکثر ۱۲۸ حرف|
|lname|string|نام خانوادگی به طول حداکثر ۱۲۸ حرف|
|status|number|وضعیت کاربر (0: غیرفعال - 1: فعال)|
|expiry_date|Unix time|تاریخ انقضا|
|is_public|bool|کاربر عمومی|
|time_limit|number|محدودیت زمانی (ساعت)|
|time_usage|number|زمان مصرف شده (ساعت)|
|time_total|number|مجموع زمان مصرف شده (ساعت)|
|create_time|Unix time|زمان ایجاد کاربر|
|update_time|Unix time|آخرین بروزرسانی کاربر|

#### توابع کاربر
|نام تابع|شرح|مقدار بازگشتی|نوع مقدار بازگشتی
|:---|---:|---:|
|`getUsers`|دریافت لیست کاربران موجود|لیست کاربران|[]
|`getUser`|دریافت مشخصات یک کاربر|مشخصات کاربر|{}
|`createUser`|ایجاد کاربر جدید|شناسه کاربر ایجاد شده|number
|`updateUser`|بروزرسانی کاربر|true یا false|bool
|`deleteUser`|حذف کاربر|true یا false|bool
|`addUserToRoom`|افزودن کاربر به اتاق|true یا false|bool
|`removeUserFromRoom`|حذف کاربر از اتاق|true یا false|bool

#### دریافت لیست کاربران موجود
##### درخواست:
```json
{
  "action": "getUsers"
}
```

##### پاسخ:
```json
[
  {
    "id": 1,
    "username": "parham",
    "nickname": "پرهام",
    "status": 1
  },
  {
    "id": 3,
    "username": "sepideh",
    "nickname": "سپیده",
    "status": 1
  }
]
```

#### دریافت مشخصات یک کاربر
##### درخواست:
```json
{
  "action": "getUser",
  "user_id": 1
}
```

##### پاسخ:
```json
{
  "id": 1,
  "username": "parham",
  "email": "p.abedini3342@gmail.com",
  "nickname": "پرهام",
  "fname": "پرهام",
  "lname": "عابدینی",
  "status": 1,
  "is_public": false,
  "expiry_date": null,
  "time_limit": null,
  "time_usage": 426466,
  "time_total": 8464516,
  "create_time": 1489021434,
  "update_time": 1489021434
}
```

#### ایجاد کاربر جدید
##### درخواست:
```json
{
  "action": "createUser",
  "username": "test-user",
  "password": "tu-2017!",
  "nickname": "کاربر عمومی",
  "status": 1,
  "is_public": true
}
```

##### پاسخ:
```json
4
```

#### بروزرسانی کاربر
##### درخواست:
```json
{
  "action": "updateUser",
  "id": 4,
  "status": 0
}
```

##### پاسخ:
```json
true
```

#### حذف کاربر
##### درخواست:
```json
{
  "action": "deleteUser",
  "id": 4
}
```

##### پاسخ:
```json
true
```

#### افزودن کاربر به اتاق
##### درخواست:
```json
{
  "action": "addUserToRoom",
  "user_id": 4,
  "room_id": 3
}
```

##### پاسخ:
```json
true
```

#### حذف کاربر از اتاق
##### درخواست:
```json
{
  "action": "removeUserFromRoom",
  "user_id": 4,
  "room_id": 3
}
```

##### پاسخ:
```json
true
```
